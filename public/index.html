<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>FiloFax - Corporate Tracker</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
<style>
  body { font-family: Arial; background: #f4f6f8; margin: 0; padding: 10px; }
  .container { max-width: 900px; margin: auto; background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 12px rgba(0,0,0,0.15); }
  input, button, select { width: 100%; margin: 8px 0; padding: 10px; border-radius: 8px; border: 1px solid #ccc; box-sizing: border-box; }
  button { background-color: #6a0dad; color: white; font-weight: bold; cursor: pointer; border: none; }
  button:hover { background-color: #4b0082; }
  table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.9em; }
  th, td { border: 1px solid #ccc; text-align: left; padding: 8px; word-break: break-word; }
  th { background: #6a0dad; color: white; }
  .hidden { display: none; }
  .tab-btn { width: 48%; background: #f4f4f4; color: #333; border: 1px solid #ccc; font-size: 0.9em; padding: 8px; border-radius: 6px; }
  .tab-btn.active { background: #6a0dad; color: #fff; }
  #messageBox { margin-top: 10px; padding: 10px; border-radius: 8px; text-align: center; font-size: 0.9em; }
  .success { background: #e6ffed; color: #056608; }
  .error { background: #ffe6e6; color: #a30000; }
  .logo { text-align:center; margin-bottom: 20px; }
  .logo h1 { color:#6a0dad; font-size:2em; font-weight:bold; margin:0; }
  .details-section { margin-top: 20px; border-top: 2px solid #ccc; padding-top: 15px; }
  .dashboard { display:flex; gap:12px; margin-bottom:12px; flex-wrap:wrap; }
  .dash-card { flex:1; min-width:220px; padding:12px; border-radius:8px; background:#f9f9fb; box-shadow: 0 1px 4px rgba(0,0,0,0.06); }
  .small { font-size:0.9em; color:#666; }
  .upcoming-list { max-height:160px; overflow:auto; }
  .notify-badge { background:#ffefc7; padding:6px; border-radius:6px; display:inline-block; margin-top:6px; }
</style>
</head>
<body>

<div class="logo"><h1>💰FiloFax</h1></div>

<!-- AUTH -->
<div class="container" id="auth-section">
  <h2>Login / Register</h2>
  <input type="email" id="email" placeholder="Email" />
  <input type="password" id="password" placeholder="Password" />
  <button id="loginBtn">Login</button>
  <button id="registerBtn">Register</button>
  <p id="authMessage"></p>
</div>

<!-- APP -->
<div class="container hidden" id="app-section">
  <!-- DASHBOARD (TOP) -->
  <div id="dashboardTop" class="dashboard hidden">
    <div class="dash-card">
      <h3>Total Amount Paid</h3>
      <p id="totalPaid" style="font-size:1.5em; font-weight:700;">$0.00</p>
      <p class="small">Connected to your payments</p>
    </div>
    <div class="dash-card">
      <h3>Upcoming Due Payments (next 30 days)</h3>
      <div id="upcomingDues" class="upcoming-list small">No upcoming due payments.</div>
    </div>
    <div class="dash-card">
      <h3>Notification Settings</h3>
      <label class="small">Send reminder email (days before due):</label>
      <input type="number" id="notifyDaysDefault" value="3" min="0" />
      <label class="small">Notification from (email):</label>
      <input type="email" id="notifyFromEmail" value="constantlycodingllc@gmail.com" />
      <button id="runNotifyBtn" style="margin-top:8px;background-color:#007bff;">Run Notifications Now</button>
      <p class="small" style="margin-top:8px;">Reminders use your Supabase Edge Function `send_due_notifications` (if deployed) and an in-app alert fallback.</p>
    </div>
  </div>

  <h2>Financial Tracker</h2>
  <p id="welcome"></p>
  <p id="roleDisplay"></p>

  <div style="display:flex; justify-content:space-between;">
    <button id="trackerTab" class="tab-btn active">My Payments</button>
    <button id="directoryTab" class="tab-btn">User Directory</button>
  </div>

  <!-- BUDGET CONTROL (Admin/Owner only) -->
  <div id="budgetSetSection" class="hidden">
    <label>Set Budget for Employee</label>
    <input type="text" id="budgetUserEmail" placeholder="Employee Email" />
    <input type="number" id="budgetAmount" placeholder="Budget Amount" />
    <button id="setBudgetBtn">Set Budget</button>
  </div>

  <!-- PAYMENT TRACKER -->
  <div id="trackerView">
    <label>Purchase Order Number</label>
    <input type="text" id="invoice" placeholder="PO Number " />

    <label>Invoice </label>
    <input type="text" id="invoice" placeholder="Enter Invoice # " />

    <label>Bill Type</label>
    <input type="text" id="company" placeholder="Enter Company Name" />

    <label>Payer Name / Email</label>
    <input type="text" id="customer" placeholder="Payer Name or Email" />

    <label>Amount Paid ($)</label>
    <input type="number" id="amount" placeholder="Enter Amount Paid" step="0.01" />

    <label>Date Paid</label>
    <input type="date" id="date_paid" />

    <label>Payment Type</label>
    <select id="payment_type">
      <option value="">Select Payment Type</option>
      <option value="Stripe">Stripe</option>
      <option value="PayPal">PayPal</option>
      <option value="Cash">Cash</option>
      <option value="Bank Transfer">Bank Transfer</option>
      <option value="Other">Other</option>
    </select>

    <label>Deposited date</label>
    <label><input type="checkbox" id="deposited" /> Tap box if deposited</label>
    <input type="date" id="deposited_date" />

    <label>Due Date (optional)</label>
    <input type="date" id="due_date" />

    <label>Recurring</label>
    <select id="recurring">
      <option value="">None</option>
      <option value="monthly">Monthly</option>
      <option value="bi-weekly">Bi-Weekly</option>
      <option value="annually">Annually</option>
    </select>

    <label>Notes (tracking)</label>
    <input type="text" id="notes" placeholder="Any notes, tracking info, etc." />

    <label>Send reminder (days before due) for this payment (optional)</label>
    <input type="number" id="notify_days_before" placeholder="e.g., 3" min="0" />

    <button id="addPaymentBtn">Add Payment</button>
    <div id="messageBox"></div>

    <button id="exportCSVBtn" style="background-color:#ff6600;">Export Payments CSV</button>
    <button id="exportExcelBtn" style="background-color:#ff6600;">Export Payments Excel</button>
    <input type="file" id="uploadFile" accept=".xlsx,.csv" />
    <button id="uploadBtn" style="background-color:#28a745;">Upload File</button>

    <label>Search Payments:</label>
    <input type="text" id="searchPayments" placeholder="Search by invoice, customer, company, notes, or type..." />

    <!-- Submission History -->
    <div class="details-section">
      <h3>My Submission History</h3>
      <table>
        <thead>
          <tr><th>Invoice</th><th>Company</th><th>Customer</th><th>Amount</th><th>Date</th><th>Type</th><th>Deposited</th><th>Due Date</th><th>Recurring</th><th>Notes</th></tr>
        </thead>
        <tbody id="myHistoryTable"></tbody>
      </table>
    </div>
  </div>

  <!-- USER DIRECTORY -->
  <div id="directoryView" class="hidden">
    <h3>User Directory</h3>
    <table>
      <thead>
        <tr><th>Email</th><th>Role</th><th>Budget</th></tr>
      </thead>
      <tbody id="userDirectory"></tbody>
    </table>
  </div>
</div>

<script>
 // --- SUPABASE CONFIG ---
    const SUPABASE_URL = "https://mqzawrkklhxspurkddhy.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1xemF3cmtrbGh4c3B1cmtkZGh5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA2NDczNDMsImV4cCI6MjA3NjIyMzM0M30.2GGjMG2jM1o89wb__u_D6-xHwjVG57VDSYf8rzQcGss";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  const authSection = document.getElementById('auth-section');
  const appSection = document.getElementById('app-section');
  const loginBtn = document.getElementById('loginBtn');
  const registerBtn = document.getElementById('registerBtn');
  const authMessage = document.getElementById('authMessage');
  const welcome = document.getElementById('welcome');
  const roleDisplay = document.getElementById('roleDisplay');

  let currentUser;

  async function login() {
    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;
    const { data, error } = await supabase.auth.signInWithPassword({ email, password });
    if (error) return authMessage.innerText = error.message;
    currentUser = data.user;
    authSection.classList.add('hidden');
    appSection.classList.remove('hidden');
    welcome.innerText = `Welcome, ${currentUser.email}`;
    loadDashboard();
    loadUserRole();
  }

  async function register() {
    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;
    const { data, error } = await supabase.auth.signUp({ email, password });
    if (error) return authMessage.innerText = error.message;
    authMessage.innerText = "Registration successful. Please log in.";
  }

  loginBtn.addEventListener('click', login);
  registerBtn.addEventListener('click', register);

  // Tabs
  const trackerTab = document.getElementById('trackerTab');
  const directoryTab = document.getElementById('directoryTab');
  const trackerView = document.getElementById('trackerView');
  const directoryView = document.getElementById('directoryView');

  trackerTab.addEventListener('click', () => { trackerTab.classList.add('active'); directoryTab.classList.remove('active'); trackerView.classList.remove('hidden'); directoryView.classList.add('hidden'); });
  directoryTab.addEventListener('click', () => { trackerTab.classList.remove('active'); directoryTab.classList.add('active'); trackerView.classList.add('hidden'); directoryView.classList.remove('hidden'); loadDirectory(); });

  // Add Payment
  const addPaymentBtn = document.getElementById('addPaymentBtn');
  const messageBox = document.getElementById('messageBox');

  addPaymentBtn.addEventListener('click', async () => {
    const invoice = document.getElementById('invoice').value;
    const company = document.getElementById('company').value;
    const customer = document.getElementById('customer').value;
    const amount_paid = parseFloat(document.getElementById('amount').value);
    const date_paid = document.getElementById('date_paid').value;
    const payment_type = document.getElementById('payment_type').value;
    const deposited = document.getElementById('deposited').checked;
    const deposited_date = document.getElementById('deposited_date').value;
    const due_date = document.getElementById('due_date').value;
    const recurring = document.getElementById('recurring').value;
    const notes = document.getElementById('notes').value;
    const notify_days_before = document.getElementById('notify_days_before').value 
      ? parseInt(document.getElementById('notify_days_before').value) 
      : parseInt(document.getElementById('notifyDaysDefault').value) || 3;

    const insertObj = {
      user_email: currentUser.email,
      created_by: currentUser.id,
      invoice, company, customer, amount: amount_paid,
      date_paid, payment_type, deposited, deposited_date,
      due_date, recurring, notes, notify_days_before
    };

    const { data, error } = await supabase.from('payments').insert([insertObj]);
    if (error) { messageBox.className = 'error'; messageBox.innerText = error.message; }
    else { messageBox.className = 'success'; messageBox.innerText = 'Payment added successfully'; loadDashboard(); }
  });

  const myHistoryTable = document.getElementById('myHistoryTable');
  const totalPaidEl = document.getElementById('totalPaid');
  const upcomingDuesEl = document.getElementById('upcomingDues');

  async function loadDashboard() {
    const { data: payments } = await supabase.from('payments').select('*').eq('user_email', currentUser.email);
    let total = 0;
    let dues = [];
    payments.forEach(p => { total += p.amount || 0; if(p.due_date) dues.push(p); });
    totalPaidEl.innerText = `$${total.toFixed(2)}`;
    upcomingDuesEl.innerHTML = dues.length ? dues.map(d => {
      const daysLeft = Math.ceil((new Date(d.due_date) - new Date()) / (1000*60*60*24));
      const notifyDays = d.notify_days_before != null ? d.notify_days_before : parseInt(document.getElementById('notifyDaysDefault').value) || 3;
      const badge = daysLeft <= notifyDays ? `<span class="notify-badge">⚠️ Notify soon</span>` : '';
      return `<div style="padding:6px;border-bottom:1px dashed #eee;">
        <strong>${d.company||d.customer||'No company'}</strong> — $${(d.amount||0).toFixed(2)} ${badge}<br/>
        <span class="small">Due: ${d.due_date} (${daysLeft} days)</span><br/>
        <span class="small">Recurring: ${d.recurring||'No'}</span>
      </div>`;
    }).join('') : 'No upcoming due payments.';

    myHistoryTable.innerHTML = payments.map(p => `<tr>
      <td>${p.invoice||''}</td>
      <td>${p.company||''}</td>
      <td>${p.customer||''}</td>
      <td>$${(p.amount||0).toFixed(2)}</td>
      <td>${p.date_paid||''}</td>
      <td>${p.payment_type||''}</td>
      <td>${p.deposited? 'Yes' : 'No'}</td>
      <td>${p.due_date||''}</td>
      <td>${p.recurring||''}</td>
      <td>${p.notes||''}</td>
    </tr>`).join('');
  }

  async function loadUserRole() {
    const { data } = await supabase.from('users').select('*').eq('email', currentUser.email);
    if(data && data.length) { roleDisplay.innerText = `Role: ${data[0].role || 'Employee'}`; }
  }

  async function loadDirectory() {
    const { data: users } = await supabase.from('users').select('*');
    const table = document.getElementById('userDirectory');
    table.innerHTML = users.map(u => `<tr><td>${u.email}</td><td>${u.role}</td><td>${u.budget||0}</td></tr>`).join('');
  }

  // Notifications button
  document.getElementById('runNotifyBtn').addEventListener('click', async () => {
    messageBox.className = 'success'; messageBox.innerText = 'Running notifications...';
    try {
      const daysDefault = parseInt(document.getElementById('notifyDaysDefault').value) || 3;
      const { data } = await supabase.from('payments').select('*');
      const now = new Date();
      const notifyPayments = data.filter(p => {
        if(!p.due_date) return false;
        const diff = (new Date(p.due_date) - now)/(1000*60*60*24);
        const notifyDays = p.notify_days_before != null ? p.notify_days_before : daysDefault;
        return diff <= notifyDays && diff >=0;
      });
      if(notifyPayments.length === 0) { messageBox.innerText = 'No notifications to send.'; return; }
      notifyPayments.forEach(p => console.log('Notify:', p.customer||p.user_email, 'due:', p.due_date));
      messageBox.innerText = `Notifications processed for ${notifyPayments.length} payments (check console).`;
    } catch(e) { messageBox.className = 'error'; messageBox.innerText = e.message; }
  });
</script>
</body>
</html>
