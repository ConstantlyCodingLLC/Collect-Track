<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>FiloFax - Corporate Tracker</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
<style>
body { font-family: Arial; background: #f4f6f8; margin: 0; padding: 10px; }
.container { max-width: 800px; margin: auto; background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 12px rgba(0,0,0,0.15); }
input, button, select { width: 100%; margin: 8px 0; padding: 10px; border-radius: 8px; border: 1px solid #ccc; box-sizing: border-box; }
button { background-color: #6a0dad; color: white; font-weight: bold; cursor: pointer; border: none; }
button:hover { background-color: #4b0082; }
table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.9em; }
th, td { border: 1px solid #ccc; text-align: left; padding: 8px; word-break: break-word; }
th { background: #6a0dad; color: white; }
.hidden { display: none; }
.tab-btn { width: 48%; background: #f4f4f4; color: #333; border: 1px solid #ccc; font-size: 0.9em; }
.tab-btn.active { background: #6a0dad; color: #fff; }
#messageBox { margin-top: 10px; padding: 10px; border-radius: 8px; text-align: center; font-size: 0.9em; }
.success { background: #e6ffed; color: #056608; }
.error { background: #ffe6e6; color: #a30000; }
.logo { text-align:center; margin-bottom: 20px; }
.logo h1 { color:#6a0dad; font-size:2em; font-weight:bold; margin:0; }
.details-section { margin-top: 20px; border-top: 2px solid #ccc; padding-top: 15px; }
</style>
</head>
<body>

<div class="logo"><h1>💰FiloFax</h1></div>

<!-- AUTH -->
<div class="container" id="auth-section">
<h2>Login / Register</h2>
<input type="email" id="email" placeholder="Email" />
<input type="password" id="password" placeholder="Password" />
<button id="loginBtn">Login</button>
<button id="registerBtn">Register</button>
<p id="authMessage"></p>
</div>

<!-- APP -->
<div class="container hidden" id="app-section">
<h2>Financial Tracker</h2>
<p id="welcome"></p>
<p id="roleDisplay"></p>

<div style="display:flex; justify-content:space-between;">
  <button id="trackerTab" class="tab-btn active">My Payments</button>
  <button id="directoryTab" class="tab-btn">User Directory</button>
</div>

<!-- BUDGET CONTROL (Admin/Owner only) -->
<div id="budgetSetSection" class="hidden">
  <label>Set Budget for Employee</label>
  <input type="text" id="budgetUserEmail" placeholder="Employee Email" />
  <input type="number" id="budgetAmount" placeholder="Budget Amount" />
  <button id="setBudgetBtn">Set Budget</button>
</div>

<!-- PAYMENT TRACKER -->
<div id="trackerView">
  <label>Invoice / PO Number</label>
  <input type="text" id="invoice" placeholder="Enter Invoice # Or PO Number" />

  <label>Customer Name / Email</label>
  <input type="text" id="customer" placeholder="Enter Customer Name or Email" />

  <label>Amount ($)</label>
  <input type="number" id="amount" placeholder="Enter Amount" step="0.01" />

  <label>Date Paid</label>
  <input type="date" id="date_paid" />

  <label>Payment Type</label>
  <select id="payment_type">
    <option value="">Select Payment Type</option>
    <option value="Stripe">Stripe</option>
    <option value="PayPal">PayPal</option>
    <option value="Cash">Cash</option>
    <option value="Bank Transfer">Bank Transfer</option>
    <option value="Other">Other</option>
  </select>

  <label><input type="checkbox" id="deposited" /> Deposited?</label>
  <label>Deposited Date</label>
  <input type="date" id="deposited_date" />

  <button id="addPaymentBtn">Add Payment</button>
  <div id="messageBox"></div>

  <button id="exportCSVBtn" style="background-color:#ff6600;">Export Payments CSV</button>
  <button id="exportExcelBtn" style="background-color:#ff6600;">Export Payments Excel</button>
  <input type="file" id="uploadFile" accept=".xlsx,.csv" />
  <button id="uploadBtn" style="background-color:#28a745;">Upload File</button>

  <label>Search Payments:</label>
  <input type="text" id="searchPayments" placeholder="Search by invoice, customer, or type..." />

  <h3>Budget</h3>
  <p id="budgetDisplay">$0.00</p>

  <!-- Submission History -->
  <div class="details-section">
    <h3>My Submission History</h3>
    <table>
      <thead>
        <tr><th>Invoice</th><th>Customer</th><th>Amount</th><th>Date</th><th>Type</th><th>Deposited</th></tr>
      </thead>
      <tbody id="myHistoryTable"></tbody>
    </table>
  </div>
</div>

<!-- USER DIRECTORY -->
<div id="directoryView" class="hidden">
<h3>All Users</h3>
<table>
  <thead>
    <tr><th>User Email</th><th>Role</th><th>Total Payments ($)</th></tr>
  </thead>
  <tbody id="userDirectoryTable"></tbody>
</table>

<h3>Assign Roles (BusinessOwner & Admin only)</h3>
<label>User Email</label>
<input type="text" id="roleUserEmail" placeholder="User Email" />
<label>Role</label>
<select id="roleSelect">
  <option value="">Select Role</option>
  <option value="Employee">Employee</option>
  <option value="BusinessOwner">BusinessOwner</option>
  <option value="Admin">Admin</option>
</select>
<button id="assignRoleBtn">Assign Role</button>
</div>

<button id="logoutBtn">Logout</button>
</div>

<script>
const SUPABASE_URL = "https://mqzawrkklhxspurkddhy.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1xemF3cmtrbGh4c3B1cmtkZGh5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA2NDczNDMsImV4cCI6MjA3NjIyMzM0M30.2GGjMG2jM1o89wb__u_D6-xHwjVG57VDSYf8rzQcGss";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const authSection = document.getElementById('auth-section');
const appSection = document.getElementById('app-section');
const paymentsTable = document.getElementById('paymentsTable');
const myHistoryTable = document.getElementById('myHistoryTable');
const userDirectoryTable = document.getElementById('userDirectoryTable');
const welcome = document.getElementById('welcome');
const roleDisplay = document.getElementById('roleDisplay');
const messageBox = document.getElementById('messageBox');

function showMessage(msg, type="success") {
  messageBox.textContent = msg;
  messageBox.className = type==="error"?"error":"success";
  setTimeout(()=>messageBox.textContent="",4000);
}

document.getElementById('loginBtn').addEventListener('click', async()=>{
  const email=document.getElementById('email').value;
  const password=document.getElementById('password').value;
  const {data,error}=await supabase.auth.signInWithPassword({email,password});
  if(error) return document.getElementById('authMessage').textContent="❌ "+error.message;
  showApp(data.user);
});

document.getElementById('registerBtn').addEventListener('click', async()=>{
  const email=document.getElementById('email').value;
  const password=document.getElementById('password').value;
  const {data,error}=await supabase.auth.signUp({email,password});
  if(error) return document.getElementById('authMessage').textContent="❌ "+error.message;
  document.getElementById('authMessage').textContent="✅ Registered successfully!";
});

async function showApp(user){
  authSection.classList.add('hidden');
  appSection.classList.remove('hidden');
  welcome.textContent=`Welcome, ${user.email}`;

  // -------------------------
  // Ensure the user has a profile
  const { data: existingProfile } = await supabase
    .from('profiles')
    .select('id, role')
    .eq('id', user.id)
    .single();

  if(!existingProfile){
    await supabase.from('profiles').insert({
      id: user.id,
      email: user.email,  // optional, keeps email in profile
      role: user.email === 'constantlycodingllc@gmail.com' ? 'Admin' : 'Employee'
    });
  }
  // -------------------------

  const { data: profile } = await supabase.from('profiles').select('role').eq('id', user.id).single();
  const role = profile?.role || 'Employee';
  roleDisplay.textContent=`Role: ${role}`;

  loadPayments(user.email, role);
  loadMyHistory(user.email);
  loadUserDirectory(role);

  if(role==='Employee'){ document.getElementById('directoryTab').style.display='none'; }
  if(role==='Employee'){ document.getElementById('assignRoleBtn').style.display='none'; }
}

document.getElementById('logoutBtn').addEventListener('click', async()=>{
  await supabase.auth.signOut();
  appSection.classList.add('hidden');
  authSection.classList.remove('hidden');
});

document.getElementById('addPaymentBtn').addEventListener('click', async()=>{
  const { data:{ user } } = await supabase.auth.getUser();
  const invoice=document.getElementById('invoice').value.trim();
  const customer=document.getElementById('customer').value.trim();
  const amount=parseFloat(document.getElementById('amount').value);
  const date_paid=document.getElementById('date_paid').value;
  const payment_type=document.getElementById('payment_type').value;
  const deposited=document.getElementById('deposited').checked;
  const deposited_date=document.getElementById('deposited_date').value || null;

  if(!invoice||!customer||!amount||!date_paid||!payment_type){
    return showMessage("All fields except deposited date are required.","error");
  }

  const { error } = await supabase.from('payments').insert([{user_email:user.email,created_by:user.id,invoice,customer,amount,date_paid,payment_type,deposited,deposited_date}]);
  if(error) showMessage("❌ "+error.message,"error");
  else{
    showMessage("✅ Payment added successfully!");
    loadMyHistory(user.email);
    document.querySelectorAll('#trackerView input, #trackerView select').forEach(i=>{ if(i.type==='checkbox') i.checked=false; else i.value=''; });
  }
});

async function loadMyHistory(userEmail){
  const { data, error } = await supabase.from('payments').select('*').eq('user_email',userEmail).order('date_paid',{ascending:false});
  myHistoryTable.innerHTML='';
  if(error || !data.length){
    myHistoryTable.innerHTML = "<tr><td colspan='6'>No submissions yet.</td></tr>";
    return;
  }
  data.forEach(p=>{
    myHistoryTable.innerHTML+=`
      <tr>
        <td>${p.invoice}</td>
        <td>${p.customer}</td>
        <td>$${p.amount.toFixed(2)}</td>
        <td>${p.date_paid}</td>
        <td>${p.payment_type}</td>
        <td>${p.deposited?'✅':'❌'}</td>
      </tr>`;
  });
}

async function loadUserDirectory(role){
  const { data, error } = await supabase.from('profiles').select('email,role');
  if(error||!data.length) return;
  userDirectoryTable.innerHTML='';
  for(const u of data){
    let total=0;
    if(role==='Admin'||role==='BusinessOwner'){
      const payments = await supabase.from('payments').select('amount').eq('user_email',u.email);
      total=payments.data.reduce((a,b)=>a+b.amount,0);
    }
    userDirectoryTable.innerHTML+=`<tr><td>${u.email}</td><td>${u.role}</td><td>$${total.toFixed(2)}</td></tr>`;
  }
}
</script>
</body>
</html>
