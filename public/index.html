<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>FiloFax - Financial Tracker</title>

<!-- === PWA / Install (ADDED) === -->
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#6a0dad" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="default" />
<link rel="apple-touch-icon" href="/icons/icon-192.png" />
<!-- === END PWA / Install === -->

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
<style>
  body { font-family: Arial; background: #f4f6f8; margin: 0; padding: 10px; }
  .container { max-width: 900px; margin: auto; background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 12px rgba(0,0,0,0.15); }
  input, button, select { width: 100%; margin: 8px 0; padding: 10px; border-radius: 8px; border: 1px solid #ccc; box-sizing: border-box; }
  button { background-color: #6a0dad; color: white; font-weight: bold; cursor: pointer; border: none; }
  button:hover { background-color: #4b0082; }
  table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.9em; }
  th, td { border: 1px solid #ccc; text-align: left; padding: 8px; word-break: break-word; }
  th { background: #6a0dad; color: white; }
  .hidden { display: none; }
  .tab-btn { width: 48%; background: #f4f4f4; color: #333; border: 1px solid #ccc; font-size: 0.9em; padding: 8px; border-radius: 6px; }
  .tab-btn.active { background: #6a0dad; color: #fff; }
  #messageBox { margin-top: 10px; padding: 10px; border-radius: 8px; text-align: center; font-size: 0.9em; }
  .success { background: #e6ffed; color: #056608; }
  .error { background: #ffe6e6; color: #a30000; }
  .logo { text-align:center; margin-bottom: 20px; }
  .logo h1 { color:#6a0dad; font-size:2em; font-weight:bold; margin:0; }
  .details-section { margin-top: 20px; border-top: 2px solid #ccc; padding-top: 15px; }
  .dashboard { display:flex; gap:12px; margin-bottom:12px; flex-wrap:wrap; }
  .dash-card { flex:1; min-width:220px; padding:12px; border-radius:8px; background:#f9f9fb; box-shadow: 0 1px 4px rgba(0,0,0,0.06); }
  .small { font-size:0.9em; color:#666; }
  .upcoming-list { max-height:160px; overflow:auto; }
  .notify-badge { background:#ffefc7; padding:6px; border-radius:6px; display:inline-block; margin-top:6px; }
   /* --- MOBILE ENHANCEMENTS --- */
  @media (max-width: 768px) {
    body { padding: 5px; }
    .container { padding: 15px; border-radius: 10px; }
    .dashboard { flex-direction: column; }
    .tab-btn { width: 100%; margin-bottom: 8px; }
    input, button, select { font-size: 0.95em; }
    .dash-card h3 { font-size: 1em; }
    .dash-card p { font-size: 1em; }
    .logo h1 { font-size: 1.6em; }

    /* Make Submission History scrollable */
    .details-section { overflow-x: auto; }
    .details-section table {
      width: 100%;
      min-width: 800px;
      display: block;
      overflow-x: auto;
      white-space: nowrap;
      border-radius: 8px;
    }
    .details-section th, .details-section td {
      padding: 10px 6px;
      font-size: 0.85em;
    }

    /* Sticky table header for better readability */
    .details-section thead th {
      position: sticky;
      top: 0;
      background: #6a0dad;
      z-index: 2;
    }

    /* Adjust buttons */
    #exportCSVBtn, #exportExcelBtn, #prepareUploadBtn, #uploadBtn {
      width: 100%;
      margin-top: 6px;
      font-size: 0.95em;
    }

    /* Search and labels spacing */
    label { font-size: 0.9em; }
    #searchPayments { font-size: 0.9em; }
  }

  /* --- EXTRA SMALL DEVICES --- */
  @media (max-width: 480px) {
    .logo h1 { font-size: 1.4em; }
    button { padding: 9px; font-size: 0.9em; }
    input, select { padding: 8px; font-size: 0.9em; }
    th, td { padding: 6px; font-size: 0.8em; }
  }

  /* === Install banner small styling (ADDED) === */
  #installBanner { max-width:900px;margin:12px auto;padding:10px;border-radius:10px;background:#fff;box-shadow:0 2px 8px rgba(0,0,0,0.06);display:none;align-items:center;gap:12px;font-family:Arial; }
  #installBanner button{ background:#6a0dad;color:white;border:none;padding:8px 10px;border-radius:8px;cursor:pointer;font-weight:bold;}
  #installBanner .secondary{ background:#f4f4f4;color:#333; }
  /* === end install banner === */
</style>
</head>
<body>

<div class="logo"><h1>üí∞FiloFax</h1></div>

<!-- === Install banner (ADDED) - will show on supported devices without changing layout === -->
<div id="installBanner" role="region" aria-label="Install Filofax">
  <div style="flex:1;">
    <strong>Install Filofax</strong>
    <div style="font-size:0.9em;color:#666">Install this app to your device for fast access and offline use.</div>
  </div>
  <div style="display:flex;gap:8px;">
    <button id="installBtn">Install</button>
    <button id="installDismiss" class="secondary">Dismiss</button>
  </div>
</div>
<!-- === end install banner === -->

<!-- AUTH -->
<div class="container" id="auth-section">
  <h2>Login / Register</h2>
  <input type="email" id="email" placeholder="Email" />
  <input type="password" id="password" placeholder="Password" />
  <button id="loginBtn">Login</button>
  <button id="registerBtn">Register</button>
  <p id="authMessage"></p>
</div>

<!-- APP -->
<div class="container hidden" id="app-section">
  <div id="dashboardTop" class="dashboard hidden">
    <div class="dash-card">
      <h3>Total Amount Paid</h3>
      <p id="totalPaid" style="font-size:1.5em; font-weight:700;">$0.00</p>
      <p class="small">Connected to your payments</p>
    </div>
    <div class="dash-card">
      <h3>Upcoming Due Payments (next 30 days)</h3>
      <div id="upcomingDues" class="upcoming-list small">No upcoming due payments.</div>
    </div>
  </div>

  <h2>Financial Tracker</h2>
  <p id="welcome"></p>

  <div style="display:flex; justify-content:space-between;">
    <button id="trackerTab" class="tab-btn active">My Payments</button>
    <button id="directoryTab" class="tab-btn">User Directory</button>
  </div>

  <!-- Add this to your dashboard HTML page -->
<div id="money-saved-dashboard" style="
  background:#fff;
  border-radius:12px;
  box-shadow:0 2px 10px rgba(0,0,0,0.1);
  padding:20px;
  max-width:400px;
  margin:auto;
  text-align:center;
  font-family:Arial,sans-serif;
">
  <h2 style="color:#6a0dad;">Money Saved Dashboard</h2>
  <p><strong>Total Received:</strong> $<span id="totalReceived">0.00</span></p>
  <p><strong>Total Outstanding:</strong> $<span id="totalOutstanding">0.00</span></p>
  <p><strong>Money Saved (10%):</strong> $<span id="moneySaved">0.00</span></p>
  <small style="color:#777;">Auto-calculated from payment records</small>
</div>

 
  <!-- PAYMENT TRACKER -->
  <div id="trackerView">
    <label>Purchase Order Number</label>
    <input type="text" id="po_number" placeholder="PO" />
    
    <label>Invoice</label>
    <input type="text" id="invoice" placeholder="Invoice #" />

    <label>Bill</label>
    <input type="text" id="company" placeholder="Enter Bill Name" />

    <label>Payer Name / Email</label>
    <input type="text" id="customer" placeholder="Payer Name or Email" />

    <label>Amount Paid ($)</label>
    <input type="number" id="amount_paid" placeholder="0.00" step="0.01" />

    <label>Date Paid</label>
    <input type="date" id="date_paid" />

    <label>Payment Type</label>
    <select id="payment_type">
      <option value="">Select Payment Type</option>
      <option value="Stripe">Stripe</option>
      <option value="PayPal">PayPal</option>
      <option value="Cash">Cash</option>
      <option value="Bank Transfer">Bank Transfer</option>
      <option value="Other">Other</option>
    </select>

    
    <label><input type="checkbox" id="deposited" /> ‚¨ÜÔ∏èClick above if Transaction Deposited & Transaction Date below</label>
    <input type="date" id="deposited_date" />

    <label>Due Date (optional)</label>
    <input type="date" id="due_date" />

    <label>Recurring (optional)</label>
    <select id="recurring">
      <option value="">None</option>
      <option value="Monthly">Monthly</option>
      <option value="Bi-Weekly">Bi-Weekly</option>
      <option value="Annually">Annually</option>
    </select>

    <label>Notes (tracking)</label>
    <input type="text" id="notes" placeholder="Any notes, tracking info, etc." />

    <label>Send reminder (days before due) for this payment (optional)</label>
    <input type="number" id="notify_days_before" placeholder="e.g., 3" min="0" />

    <button id="addPaymentBtn">Add Payment</button>
    <div id="messageBox"></div>

    <button id="exportCSVBtn" style="background-color:#ff6600;">Export Payments CSV</button>
    <button id="exportExcelBtn" style="background-color:#ff6600;">Export Payments Excel</button>
    <input type="file" id="uploadFile" accept=".xlsx,.csv" />
    <button id="prepareUploadBtn" style="background-color:#28a745;">Prepare Upload</button>
    <button id="uploadBtn" style="background-color:#28a745;" disabled>Enter Data</button>

  
       <label>Search Payments:</label>
    <input type="text" id="searchPayments" placeholder="Search by invoice, customer, company, notes, or type..." />

    <!-- Submission History -->
    <div class="details-section">
      <h3>My Submission History</h3>
      <table>
        <thead>
          <tr>
            <th>PO</th><th>Invoice</th><th>Company</th><th>Customer</th><th>Amount</th>
            <th>Date</th><th>Type</th><th>Deposited</th><th>Due Date</th><th>Recurring</th><th>Notes</th>
          </tr>
        </thead>
        <tbody id="myHistoryTable"></tbody>
      </table>
    </div>
  </div>

  <!-- USER DIRECTORY -->
  <div id="directoryView" class="hidden">
    <h3>All Users</h3>
    <table>
      <thead>
        <tr><th>User Email</th><th>Role</th><th>Total Payments ($)</th></tr>
      </thead>
      <tbody id="userDirectoryTable"></tbody>
    </table>
  </div>

  <button id="logoutBtn">Logout</button>
</div>

   <div class="container" style="margin-top:20px; text-align:center;">
  <h2>Contact Support</h2>
  <p>If you‚Äôre having issues, send us a message directly.</p>
  <a href="mailto:Constantlycodingllc@gmail.com" 
     style="text-decoration:none;">
    <button style="background-color:#6a0dad;color:white;padding:10px 20px;border:none;border-radius:8px;cursor:pointer;">
   Contact Us
    </button>
  </a>
  <p style="margin-top:8px;"></p>
</div>

<script>
/* === YOUR ORIGINAL APP SCRIPT STARTS HERE (UNCHANGED) === */
document.addEventListener('DOMContentLoaded', async () => {
    // --- SUPABASE CONFIG ---
    // --- SUPABASE CONFIG ---
    const SUPABASE_URL = "https://mqzawrkklhxspurkddhy.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1xemF3cmtrbGh4c3B1cmtkZGh5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA2NDczNDMsImV4cCI6MjA3NjIyMzM0M30.2GGjMG2jM1o89wb__u_D6-xHwjVG57VDSYf8rzQcGss";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);


    const authSection = document.getElementById('auth-section');
    const appSection = document.getElementById('app-section');
    const loginBtn = document.getElementById('loginBtn');
    const registerBtn = document.getElementById('registerBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const authMessage = document.getElementById('authMessage');

    let currentUser = null;

    async function showMessage(msg, success=true){
        const box = document.getElementById('messageBox');
        box.textContent = msg;
        box.className = success ? 'success':'error';
        setTimeout(()=>box.textContent='',4000);
    }

    async function fetchCurrentUser(){
        const { data: { user } } = await supabase.auth.getUser();
        currentUser = user;
        return user;
    }

    // --- LOGIN ---
    loginBtn.addEventListener('click', async ()=>{
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const { data, error } = await supabase.auth.signInWithPassword({email,password});
        if(error){ authMessage.textContent=error.message; authMessage.style.color='red'; return; }
        await fetchCurrentUser();
        authSection.classList.add('hidden');
        appSection.classList.remove('hidden');
        loadDashboard();
        loadPayments();
    });

    // --- REGISTER ---
    registerBtn.addEventListener('click', async ()=>{
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const { data, error } = await supabase.auth.signUp({email,password});
        if(error){ authMessage.textContent=error.message; authMessage.style.color='red'; return; }
        authMessage.textContent="Registration success! You can login now."; authMessage.style.color='green';
    });

    logoutBtn.addEventListener('click', async ()=>{
        await supabase.auth.signOut();
        authSection.classList.remove('hidden');
        appSection.classList.add('hidden');
        currentUser = null;
    });

    // --- ADD PAYMENT ---
    document.getElementById('addPaymentBtn').addEventListener('click', async()=>{
        if(!currentUser){ showMessage("Not logged in", false); return; }
        const data = {
            created_by: currentUser.id,
            user_email: currentUser.email,
            po_number: document.getElementById('po_number')?.value || null,
            invoice: document.getElementById('invoice')?.value || null,
            company: document.getElementById('company')?.value || null,
            customer: document.getElementById('customer')?.value || null,
            amount: parseFloat(document.getElementById('amount')?.value) || 0,
            amount_paid: parseFloat(document.getElementById('amount_paid')?.value) || 0,
            date_paid: document.getElementById('date_paid')?.value || null,
            payment_type: document.getElementById('payment_type')?.value || null,
            deposited: document.getElementById('deposited')?.checked || false,
            deposited_date: document.getElementById('deposited_date')?.value || null,
            due_date: document.getElementById('due_date')?.value || null,
            recurring: document.getElementById('recurring')?.value || null,
            notes: document.getElementById('notes')?.value || null,
            notify_days_before: parseInt(document.getElementById('notify_days_before')?.value) || null,
            transaction_date: null
        };
        const { error } = await supabase.from('payments').insert([data]);
        if(error){ showMessage(error.message,false); return; }
        showMessage("Payment added successfully!");
        loadPayments();
    });



  async function loadMoneySaved() {
    const user = (await supabase.auth.getUser()).data.user;
    if (!user) return console.log("Not logged in");


    
    const { data, error } = await supabase
  .from('invoices')
  .select('*')
  .or(`
    po_number.ilike.%${searchTerm}%,
    invoice.ilike.%${searchTerm}%,
    company.ilike.%${searchTerm}%,
    customer.ilike.%${searchTerm}%,
    notes.ilike.%${searchTerm}%,
    payment_type.ilike.%${searchTerm}%
  `);


    // Fetch from the money_saved_dashboard view
    const { data, error } = await supabase
      .from('money_saved_dashboard')
      .select('*')
      .eq('created_by', user.id)
      .maybeSingle();

    if (error) {
      console.error("Error loading dashboard:", error);
      return;
    }

    const totalReceived = data?.total_received || 0;
    const totalOutstanding = data?.total_outstanding || 0;
    const moneySaved = data?.money_saved_estimate || 0;

    document.getElementById("totalReceived").textContent = totalReceived.toFixed(2);
    document.getElementById("totalOutstanding").textContent = totalOutstanding.toFixed(2);
    document.getElementById("moneySaved").textContent = moneySaved.toFixed(2);
  }

  // Initial load
  loadMoneySaved();

  // Subscribe for real-time updates when payments change
  supabase
    .channel('realtime:payments')
    .on(
      'postgres_changes',
      { event: '*', schema: 'public', table: 'payments' },
      payload => {
        console.log("Payment change detected:", payload);
        loadMoneySaved();
      }
    )
    .subscribe();
  
    // --- LOAD PAYMENTS ---
    async function loadPayments(search=""){
        if(!currentUser) return;
        let query = supabase.from('payments').select('*').eq('user_email', currentUser.email);
        if(search){
            query = query.or(`
              po_number.ilike.%${search}%,
              invoice.ilike.%${search}%,
              company.ilike.%${search}%,
              customer.ilike.%${search}%,
              notes.ilike.%${search}%,
              payment_type.ilike.%${search}%
            `);
        }
        const { data, error } = await query.order('created_at',{ascending:false});
        if(error){ showMessage(error.message,false); return; }
        const tbody = document.getElementById('myHistoryTable');
        tbody.innerHTML="";
        data.forEach(row=>{
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${row.po_number||""}</td>
                <td>${row.invoice||""}</td>
                <td>${row.company||""}</td>
                <td>${row.customer||""}</td>
                <td>${row.amount_paid||0}</td>
                <td>${row.date_paid||""}</td>
                <td>${row.payment_type||""}</td>
                <td>${row.deposited? "Yes":"No"}</td>
                <td>${row.due_date||""}</td>
                <td>${row.recurring||""}</td>
                <td>${row.notes||""}</td>
            `;
            tbody.appendChild(tr);
        });
    }

    // --- SEARCH PAYMENTS ---
    document.getElementById('searchPayments').addEventListener('input', (e)=>{
        loadPayments(e.target.value);
    });

    // --- DASHBOARD ---
    async function loadDashboard(){
        if(!currentUser) return;
        const { data, error } = await supabase.from('payments').select('*').eq('user_email', currentUser.email);
        if(error) return;
        let totalPaid = 0;
        let upcoming = [];
        const today = new Date();
        const next30 = new Date();
        next30.setDate(today.getDate()+30);
        data.forEach(p=>{
            totalPaid += parseFloat(p.amount_paid||0);
            if(p.due_date){
                const due = new Date(p.due_date);
                if(due >= today && due <= next30) upcoming.push(`${p.invoice||p.po_number||'Payment'} due on ${p.due_date}`);
            }
        });
        document.getElementById('totalPaid').textContent = `$${totalPaid.toFixed(2)}`;
        const dash = document.getElementById('dashboardTop');
        dash.classList.remove('hidden');
        document.getElementById('upcomingDues').innerHTML = upcoming.length? upcoming.map(u=>`<div class="notify-badge">${u}</div>`).join(''):"No upcoming due payments.";
    }

    // --- TAB SWITCH ---
    const trackerTab = document.getElementById('trackerTab');
    const directoryTab = document.getElementById('directoryTab');
    trackerTab.addEventListener('click', ()=>{
        trackerTab.classList.add('active'); directoryTab.classList.remove('active');
        document.getElementById('trackerView').classList.remove('hidden');
        document.getElementById('directoryView').classList.add('hidden');
    });
    directoryTab.addEventListener('click', ()=>{
        trackerTab.classList.remove('active'); directoryTab.classList.add('active');
        document.getElementById('trackerView').classList.add('hidden');
        document.getElementById('directoryView').classList.remove('hidden');
        loadUserDirectory();
    });

    async function loadUserDirectory(){
        const { data, error } = await supabase.from('users').select('*');
        if(error) return;
        const tbody = document.getElementById('userDirectoryTable');
        tbody.innerHTML="";
        for(const u of data){
            const { data: payments } = await supabase.from('payments').select('amount_paid').eq('user_email', u.email);
            const total = payments.reduce((a,b)=>a+(parseFloat(b.amount_paid)||0),0);
            const tr = document.createElement('tr');
            tr.innerHTML=`<td>${u.email}</td><td>${u.role||'user'}</td><td>${total.toFixed(2)}</td>`;
            tbody.appendChild(tr);
        }
    }

    // --- EXPORT CSV ---
    document.getElementById('exportCSVBtn').addEventListener('click', async ()=>{
        if(!currentUser) return;
        const { data, error } = await supabase.from('payments').select('*').eq('user_email', currentUser.email);
        if(error){ showMessage(error.message,false); return; }
        const csvContent = [
            Object.keys(data[0]||{}).join(','),
            ...data.map(d=>Object.values(d).map(v=>`"${v||''}"`).join(','))
        ].join('\n');
        const blob = new Blob([csvContent], {type:'text/csv;charset=utf-8;'});
        saveAs(blob,'payments.csv');
    });

    // --- EXPORT EXCEL ---
    document.getElementById('exportExcelBtn').addEventListener('click', async ()=>{
        if(!currentUser) return;
        const { data, error } = await supabase.from('payments').select('*').eq('user_email', currentUser.email);
        if(error){ showMessage(error.message,false); return; }
        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Payments");
        XLSX.writeFile(wb,"payments.xlsx");
    });

    // --- FILE UPLOAD ---
    const uploadFile = document.getElementById('uploadFile');
    const prepareUploadBtn = document.getElementById('prepareUploadBtn');
    const uploadBtn = document.getElementById('uploadBtn');
    let preparedData = [];
    prepareUploadBtn.addEventListener('click', ()=>{
        const file = uploadFile.files[0];
        if(!file){ showMessage("Select a file first", false); return; }
        const reader = new FileReader();
        reader.onload = e=>{
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data,{type:"array"});
            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
            preparedData = XLSX.utils.sheet_to_json(firstSheet);
            showMessage("File prepared. Ready to enter.");
            uploadBtn.disabled=false;
        };
        reader.readAsArrayBuffer(file);
    });

    uploadBtn.addEventListener('click', async()=>{
        if(!currentUser){ showMessage("Not logged in", false); return; }
        if(preparedData.length===0){ showMessage("No data prepared", false); return; }
        try{
            for(const row of preparedData){
                const insertData = {
                    created_by: currentUser.id,
                    user_email: currentUser.email,
                    po_number: row.po_number || null,
                    invoice: row.invoice || null,
                    company: row.company || null,
                    customer: row.customer || null,
                    amount: parseFloat(row.amount)||0,
                    amount_paid: parseFloat(row.amount_paid)||0,
                    date_paid: row.date_paid || null,
                    payment_type: row.payment_type || null,
                    deposited: row.deposited || false,
                    deposited_date: row.deposited_date || null,
                    due_date: row.due_date || null,
                    recurring: row.recurring || null,
                    notes: row.notes || null,
                    notify_days_before: parseInt(row.notify_days_before) || null,
                    transaction_date: null
                };
                await supabase.from('payments').insert([insertData]);
            }
            showMessage("File data entered successfully!");
            uploadBtn.disabled=true;
            preparedData=[];
            loadPayments();
        }catch(err){ showMessage(err.message,false); }
    });

});
/* === YOUR ORIGINAL APP SCRIPT ENDS HERE (UNCHANGED) === */
</script>

<!-- === Service worker registration & PWA install handling (ADDED) === -->
<script>
  // Service worker registration
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('/service-worker.js')
        .then(() => console.log('Service Worker registered'))
        .catch(err => console.warn('Service Worker registration failed:', err));
    });
  }

  // Install prompt handling
  (function(){
    let deferredPrompt = null;
    const installBanner = document.getElementById('installBanner');
    const installBtn = document.getElementById('installBtn');
    const dismissBtn = document.getElementById('installDismiss');

    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      // show the small banner
      installBanner.style.display = 'flex';
    });

    installBtn.addEventListener('click', async () => {
      if (!deferredPrompt) {
        // fallback: open browser install instructions for iOS
        alert('If your browser supports installation, use the browser menu to install this app.');
        return;
      }
      deferredPrompt.prompt();
      const choice = await deferredPrompt.userChoice;
      deferredPrompt = null;
      installBanner.style.display = 'none';
    });

    dismissBtn.addEventListener('click', () => {
      installBanner.style.display = 'none';
    });

    // For iOS: show banner optionally if stand-alone not detected and on iOS
    const isIos = /iPhone|iPad|iPod/.test(navigator.userAgent);
    const isInStandalone = ('standalone' in window.navigator) && window.navigator.standalone;
    if (isIos && !isInStandalone) {
      // small hint only if not already installed
      const maybeShow = installBanner;
      maybeShow.style.display = 'flex';
      installBtn.textContent = 'Add to Home Screen';
      installBtn.onclick = () => { alert('Open Safari ‚Üí Share ‚Üí Add to Home Screen to install Filofax.'); };
    }
  })();

   // Add payment and send to Supabase
  addPaymentBtn.addEventListener('click', async () => {
    const name = document.getElementById('paymentFrom').value.trim();
    const amount = document.getElementById('paymentAmount').value.trim();
    const user = (await supabase.auth.getUser()).data.user;

    if (!user) {
      alert('You must be logged in.');
      return;
    }

    if (!name || !amount) {
      alert('Please enter both name and amount');
      return;
    }

    const { error } = await supabase
      .from('payments')
      .insert([{
        created_by: user.id,
        user_email: user.email,
        customer: name,
        amount: parseFloat(amount),
        payment_type: 'Received',
        transaction_date: new Date().toISOString().split('T')[0]
      }]);

    if (error) {
      console.error('Error inserting payment:', error);
      alert('Error saving payment');
      return;
    }

    // Show it on screen
    const paymentDiv = document.createElement('div');
    paymentDiv.style = `
      background-color: rgba(255,255,255,0.08);
      border-radius: 10px;
      padding: 10px;
      margin-top: 10px;
      display: flex;
      justify-content: space-between;
    `;
    paymentDiv.innerHTML = `
      <span><strong>${name}</strong></span>
      <span>$${parseFloat(amount).toFixed(2)}</span>
    `;
    paymentsList.appendChild(paymentDiv);

    document.getElementById('paymentFrom').value = '';
    document.getElementById('paymentAmount').value = '';
  });
</script>
<!-- === end PWA code additions === -->

</body>
</html>
